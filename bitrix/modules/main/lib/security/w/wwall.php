<? namespace Bitrix\Main\Security\W;$GLOBALS['____1582084716']= array(base64_decode('d'.'G'.'ltZQ='.'='),base64_decode(''.'dG'.'ltZ'.'Q=='),base64_decode('anN'.'v'.'b'.'l9kZWN'.'vZG'.'U='),base64_decode('YXJy'.'Y'.'Xlfb'.'WVy'.'Z2U='),base64_decode(''.'am9pb'.'g'.'=='),base64_decode('am9'.'pbg=='),base64_decode(''.'am9pbg=='),base64_decode('YXJy'.'Y'.'XlfcG9w'),base64_decode('YX'.'J'.'yYXl'.'fc2'.'hpZnQ'.'='),base64_decode(''.'Y'.'XJyYXl'.'fc2'.'hpZnQ='),base64_decode('YXJ'.'yYXl'.'fc2hp'.'Z'.'nQ='),base64_decode('YX'.'J'.'yY'.'Xlf'.'c'.'2hp'.'ZnQ='),base64_decode('YXJyYXlfbWV'.'yZ'.'2U='),base64_decode('a'.'XNfYXJyYXk='),base64_decode('Y'.'XJyYXlfbWV'.'yZ2U='),base64_decode('aW5fYX'.'JyYXk='),base64_decode('aW5fYXJyY'.'Xk='),base64_decode('aW5'.'fY'.'XJyYXk='),base64_decode('aW5fY'.'XJ'.'yYXk='),base64_decode('aW5fYXJ'.'y'.'Y'.'Xk='),base64_decode('dGl'.'t'.'ZQ'.'=='),base64_decode(''.'dGlt'.'ZQ='.'='),base64_decode('YXJyY'.'Xl'.'fb'.'WFw'),base64_decode('Z2V0X2xvYW'.'Rl'.'ZF'.'9leHRlb'.'nN'.'pb25'.'z'),base64_decode('an'.'Nv'.'b'.'l'.'9lbmN'.'vZGU='),base64_decode('a'.'nNvbl9lb'.'mNvZGU='),base64_decode('cG'.'hwdmVyc2lvbg=='),base64_decode('an'.'Nv'.'bl'.'9'.'lbm'.'Nv'.'ZGU='),base64_decode('am9p'.'b'.'g='.'='));if(!function_exists(__NAMESPACE__.'\\___1116726986')){function ___1116726986($_1172673808){static $_531498832= false; if($_531498832 == false) $_531498832=array(''.'V1dBT'.'Ex'.'f'.'TE9DSw==',''.'c2'.'Vj'.'d'.'XJpdHk=','REFUQQ==','e'.'y'.'I'.'=','V1dB'.'T'.'ExfTE9'.'DSw==','c2VjdXJ'.'pd'.'Hk=','U0'.'VDVVJJV'.'FlfV1dBT'.'Exf'.'RVhDRVBUSU9O',''.'RkFJTF9D'.'SE'.'VDS0'.'lORw='.'=','Q2F'.'uIG5vdCBleG'.'VjdXRlIHd'.'3Y'.'W'.'xsIHJ1'.'b'.'GVzOiA=','IFRyYW'.'NlO'.'iA=','UkVRVUVTV'.'F9VUkk=','a2'.'V5cw==','dmFs'.'dW'.'Vz','U0VD'.'VVJ'.'JVF'.'lfV1'.'dBTExf'.'T'.'U9'.'E'.'SUZZ','Lg'.'==','U0V'.'DVVJ'.'JVFlfV1dBTExfV'.'U5TRV'.'Q'.'=','Lg==','U0VDV'.'V'.'JJVF'.'lfV1dBTExfR'.'VhJVA==','Lg==','Z'.'2xvY'.'mF'.'s',''.'a2V5cw==','d'.'mF'.'sd'.'WVz','Z2V0','Z'.'2V0','cG9z'.'dA==','cG9zdA'.'==',''.'Y2'.'9va'.'2ll','Y'.'2'.'9'.'va'.'2ll','c'.'mVxdWVz'.'dA==','cmVxd'.'WVzdA==',''.'Z2x'.'v'.'YmFs','Z'.'2xvYm'.'Fs','bWFpbl'.'9zZWM'.'=','V'.'1'.'dBTEx'.'fQUNUVUFMSVpFX1JVT'.'EV'.'T','dg'.'==','dmVyc'.'2'.'lvbg'.'==','aQ==',''.'aXN'.'J'.'bnN0YW'.'xsZWQ'.'=','dg'.'='.'=','aW'.'5p',''.'bW9kdWxlc'.'w'.'==','bGlj'.'ZW5zZQ==','cGhw',''.'dg'.'='.'=','ZXh'.'0',''.'c2VjdXJpdHk=',''.'ZGI'.'=','dH'.'l'.'wZQ'.'==','Z'.'GI'.'=','dmVy'.'c2lvbg==','ZGI=','dHl'.'wZQ==','ZGI=',''.'dHlwZQ'.'==',''.'dmVyc2lvbg==',''.'ZG'.'I=','dmVyc2lvbg='.'=','ZW52a'.'XJvb'.'m1lbnQ=',''.'d'.'m1fdmV'.'yc2lvbg'.'==','dm0=','dg==','Z'.'W5'.'2aXJv'.'b'.'m1lbnQ=','d'.'m1f'.'dmVyc2l'.'vbg='.'=',''.'c2'.'9ja2V0VGl'.'tZ'.'W'.'91dA==','c3RyZ'.'WFt'.'VGltZ'.'W'.'91dA'.'='.'=','K'.'Cc=','ZG'.'F0YQ==','JywgJw==','b'.'W9k'.'d'.'Wxl',''.'J'.'y'.'wgJw'.'==','b'.'W9kdWxlX'.'3Zlc'.'nNpb2'.'4=','Jyk=','LCA=','U'.'0VDVVJJVFl'.'f'.'V'.'1d'.'BT'.'ExfR'.'V'.'hDRVBU'.'SU9O','b'.'WFp'.'b'.'g==','RkF'.'JT'.'F9S'.'RUZS'.'RV'.'N'.'I'.'SU'.'5H','Q2FuIG5vdC'.'ByZWZyZXNoI'.'Hd3YWx'.'s'.'IH'.'J'.'1b'.'G'.'VzO'.'iA=','IFRyYWN'.'lO'.'iA'.'=','Z'.'GF0YQ==','eyI=',''.'L'.'S0tLS1C'.'RUdJTiB'.'QVUJM'.'SU'.'Mg'.'S'.'0VZ'.'LS0'.'tLS0'.'=','Ck'.'1JSUJJak'.'FOQmdrcWh'.'r'.'aUc5d'.'zBCQVFFRkFBT0N'.'B'.'UThBTUlJQkNnS0NBU'.'U'.'VBcThR'.'R'.'TBIam'.'1ISl'.'VTdFd'.'WNm4wemEKUlZvTHgw'.'Mkt6Y'.'mZyY'.'lMvUDZzV2F'.'4VHp'.'3'.'OFNlR1R'.'0'.'YlRDT3JwSGk'.'1U'.'U'.'Y'.'2T1J5'.'al'.'ovWH'.'h6L0tMVT'.'FHYm9'.'mO'.'UNaMwo0e'.'j'.'dTa3FVdDY2aW'.'JY'.'dk9GQng0'.'Zn'.'cvQ'.'V'.'B'.'QUkdE'.'cXRt'.'MG'.'5EM2ZnR3N'.'1M1JlUG'.'d3'.'M'.'jlp'.'OCt2'.'bTdtdEJ'.'LSlV'.'Z'.'b'.'D'.'Ry'.'Cl'.'ZwYjZzZlpF'.'V'.'DlLRWI'.'2'.'VD'.'F'.'IRFltRXZjMWhxL2lpdXl4T'.'H'.'JaWmk'.'1UTZV'.'ZmY0V'.'U'.'V'.'2V'.'EkrNjhzc0ZSa1Erb'.'3dUU'.'n'.'kK'.'ZU9JT'.'WJGaE0'.'v'.'VVRtZlZ'.'ZYlRSRn'.'kyb1VROFdNe'.'mEybko1U2Foem'.'kxVUtPM'.'WpBa'.'lhUUFJy'.'em'.'M3QW'.'p'.'1NjM5ajFPMA'.'pw'.'cHF'.'m'.'b'.'TV4Z1dsRkFKa0hRVGd'.'i'.'ZGQ1Q'.'Vd'.'xRE'.'ZRa3Q5'.'SE'.'trWStUb'.'m'.'Z'.'C'.'TEd'.'WT'.'X'.'ZW'.'eVB3VE'.'hOV'.'1FZQXc0'.'eHBnL3dBClp3'.'SUR'.'BUU'.'FCC'.'i0tLS0tRU5EIF'.'B'.'VQkx'.'JQyB'.'LRVktLS0tLQ==');return base64_decode($_531498832[$_1172673808]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use Bitrix\Main\License\UrlProvider; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; protected $_2069864219= true; public function handle(){ try{  $_1349690184= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1349690184)){ return;}  $_427084501= Cache::createInstance(); $_309060887= false; if($_427084501->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_979746088= $_427084501->getVars(); if($GLOBALS['____1582084716'][0]()- $_979746088> round(0+5+5+5+5)){  $_692340379= Application::getConnection(); $_1983250288= RuleRecordTable::getTableName(); $_692340379->truncateTable($_1983250288); RuleRecordTable::cleanCache(); $_427084501->clean(___1116726986(0), ___1116726986(1));}} elseif($_427084501->startDataCache()){  $_427084501->endDataCache($GLOBALS['____1582084716'][1]()); $_309060887= true;} foreach($_1349690184 as $_1484149308){ $_2084489405= new PublicKeyCipher; $_843303115= $_2084489405->decrypt($_1484149308[___1116726986(2)], static::__425599039()); if(!str_starts_with($_843303115, ___1116726986(3))){ continue;} $_1746005526= $GLOBALS['____1582084716'][2]($_843303115, true); if(!empty($_1746005526)){ $_1195868848= Rule::make($_1746005526); $_2038076400= $this->handleRule($_1195868848); $this->applyHandlingResults($_2038076400);}}  if($_309060887){ $_427084501->clean(___1116726986(4), ___1116726986(5));}} catch(\Throwable $_250530012){ $this->logEvent( ___1116726986(6), ___1116726986(7), ___1116726986(8). $_250530012->getMessage(). ___1116726986(9). $_250530012->getTraceAsString());}}  public function handleRule(Rule $_1195868848): array{ $_2038076400=[]; if($_1195868848->matchPath($_SERVER[___1116726986(10)])){  $_2062172254= $this->getContextElements($_1195868848->getContext()); foreach($_2062172254 as $_1020440123 => &$_1089683238){ $_2038076400= $GLOBALS['____1582084716'][3]($_2038076400, $this->recursiveContextKeyHandle($_1020440123, $_1089683238,[], $_1195868848));}} return $_2038076400;}  public function applyHandlingResults(array $_2038076400){ $_2062172254= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_2038076400 as $_1318861727){ $_1089683238=& $_2062172254[$_1318861727->getContextName()]; $_2093081635= $_1318861727->getRuleResult(); $_1195868848= $_1318861727->getRule(); if($_2093081635 instanceof ModifyResult){ if($_1195868848->getProcess() === ___1116726986(11)){  static::rewriteContextKey( $_1318861727->getContextName(), $_1089683238, $_1318861727->getContextKey(), $_2093081635->getCleanValue());} elseif($_1195868848->getProcess() === ___1116726986(12)){ static::rewriteContextValue( $_1318861727->getContextName(), $_1089683238, $_1318861727->getContextKey(), $_2093081635->getCleanValue());} $this->logEvent( ___1116726986(13), $_1318861727->getContextName(), $GLOBALS['____1582084716'][4](___1116726986(14), $_1318861727->getContextKey()));} elseif($_2093081635 instanceof CheckResult &&!$_2093081635->isSuccess()){ if($_2093081635->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_1318861727->getContextName(), $_1089683238, $_1318861727->getContextKey(),); $this->logEvent( ___1116726986(15), $_1318861727->getContextName(), $GLOBALS['____1582084716'][5](___1116726986(16), $_1318861727->getContextKey()));} elseif($_2093081635->getAction() === RuleAction::EXIT){ $this->logEvent( ___1116726986(17), $_1318861727->getContextName(), $GLOBALS['____1582084716'][6](___1116726986(18), $_1318861727->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_2069864219= false;} protected function rewriteContextKey($_1020440123, &$_1089683238, $_1122291168, $_1003597252){ $_1743222942= $_1122291168;  $GLOBALS['____1582084716'][7]($_1743222942); $_1743222942[]= $_1003597252; if($_1020440123 === ___1116726986(19)){ $_1937548245= $GLOBALS['____1582084716'][8]($_1122291168); $GLOBALS['____1582084716'][9]($_1743222942); if(empty($_1122291168)){ $GLOBALS[$_1003597252]= $GLOBALS[$_1937548245]; unset($GLOBALS[$_1937548245]);} else{ $_1089683238=& $GLOBALS[$_1937548245]; $_1625330839= ArrayHelper::getByNestedKey($_1089683238, $_1122291168);  ArrayHelper::setByNestedKey($_1089683238, $_1743222942, $_1625330839);  ArrayHelper::unsetByNestedKey($_1089683238, $_1122291168);}} else{ $_1625330839= ArrayHelper::getByNestedKey($_1089683238, $_1122291168);  ArrayHelper::setByNestedKey($_1089683238, $_1743222942, $_1625330839);  ArrayHelper::unsetByNestedKey($_1089683238, $_1122291168);}} protected function rewriteContextValue($_1020440123, &$_1089683238, $_681571860, $_1625330839){ if($_1020440123 === 'global'){ $_1937548245= $GLOBALS['____1582084716'][10]($_681571860); if(empty($_681571860)){ $GLOBALS[$_1937548245]= $_1625330839;} else{ $_1089683238=& $GLOBALS[$_1937548245]; ArrayHelper::setByNestedKey($_1089683238, $_681571860, $_1625330839);}} else{  ArrayHelper::setByNestedKey($_1089683238, $_681571860, $_1625330839);}} protected function unsetContextValue($_1020440123, &$_1089683238, $_681571860){ if($_1020440123 === 'global'){ $_1937548245= $GLOBALS['____1582084716'][11]($_681571860); if(empty($_681571860)){ unset($GLOBALS[$_1937548245]);} else{ $_1089683238=& $GLOBALS[$_1937548245]; ArrayHelper::unsetByNestedKey($_1089683238, $_681571860);}} else{ ArrayHelper::unsetByNestedKey($_1089683238, $_681571860);}}  protected function recursiveContextKeyHandle(string $_1020440123, array &$_1089683238, array $_339186528, Rule $_1195868848): array{  $_2038076400=[]; foreach($_1089683238 as $_1770579811 => $_1625330839){ $_681571860= $GLOBALS['____1582084716'][12]($_339186528,[$_1770579811]); if($_1195868848->matchKey($_681571860)){  if($_1195868848->getProcess() === ___1116726986(20)){ $_2093081635= $_1195868848->evaluate($_1770579811);} elseif($_1195868848->getProcess() === ___1116726986(21)){ $_2093081635= $_1195868848->evaluateValue($_1625330839);}  if(!empty($_2093081635) && $_2093081635 instanceof RuleResult){ $_2038076400[]= new HandlingResult($_1020440123, $_681571860, $_2093081635, $_1195868848);}}  if($GLOBALS['____1582084716'][13]($_1625330839)){ $_2038076400= $GLOBALS['____1582084716'][14]($_2038076400, $this->recursiveContextKeyHandle( $_1020440123, $_1089683238[$_1770579811], $_681571860, $_1195868848));}} return $_2038076400;} protected function getContextElements(array $_1543740028){ $_607525378=[]; if($GLOBALS['____1582084716'][15](___1116726986(22), $_1543740028, true)){ $_607525378[___1116726986(23)]= &$_GET;} if($GLOBALS['____1582084716'][16](___1116726986(24), $_1543740028, true)){ $_607525378[___1116726986(25)]= &$_POST;} if($GLOBALS['____1582084716'][17](___1116726986(26), $_1543740028, true)){ $_607525378[___1116726986(27)]= &$_COOKIE;} if($GLOBALS['____1582084716'][18](___1116726986(28), $_1543740028, true)){ $_607525378[___1116726986(29)]= &$_REQUEST;} if($GLOBALS['____1582084716'][19](___1116726986(30), $_1543740028, true)){ $_607525378[___1116726986(31)]= $GLOBALS;} return $_607525378;} public static function refreshRules(){ try{ $_746363535= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1582084716'][20]()- $_746363535)< static::CACHE_RULES_TTL){ return;} Option::set(___1116726986(32), ___1116726986(33), $GLOBALS['____1582084716'][21]()); $_1431248948= null;  $_1554172254= $GLOBALS['____1582084716'][22](function($_533614157){ return[___1116726986(34) => $_533614157[___1116726986(35)], ___1116726986(36) => (int) $_533614157[___1116726986(37)]];}, ModuleManager::getModulesFromDisk());  $_1622894644=[]; foreach($GLOBALS['____1582084716'][23]() as $_805163112){ $_1188210832= new ReflectionExtension($_805163112); $_1622894644[$_805163112]=[ ___1116726986(38) => $_1188210832->getVersion(), ___1116726986(39) => $_1188210832->getINIEntries()];} $_1830373780=[ ___1116726986(40) => $GLOBALS['____1582084716'][24]($_1554172254), ___1116726986(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___1116726986(42) => $GLOBALS['____1582084716'][25]([ ___1116726986(43) => $GLOBALS['____1582084716'][26](), ___1116726986(44) => $_1622894644])]; if(Loader::includeModule(___1116726986(45))){ $_68032893= CSecuritySystemInformation::getSystemInformation(); if(isset($_68032893[___1116726986(46)][___1116726986(47)]) && isset($_68032893[___1116726986(48)][___1116726986(49)])){ $_1830373780[___1116726986(50)]=[ ___1116726986(51) => $_68032893[___1116726986(52)][___1116726986(53)], ___1116726986(54) => $_68032893[___1116726986(55)][___1116726986(56)]];} if(isset($_68032893[___1116726986(57)][___1116726986(58)])){ $_1830373780[___1116726986(59)]=[___1116726986(60) => $_68032893[___1116726986(61)][___1116726986(62)]];}}  $_95049154= new HttpClient([ ___1116726986(63) => round(0+1+1+1+1+1), ___1116726986(64) => round(0+2.5+2.5)]); $_410744861=(new UrlProvider())->getTechDomain(); $_1703916701="https://wwall.{$_410744861}/rules.php"; $_1079396447= $_95049154->post($_1703916701, $_1830373780); if($_95049154->getStatus() == round(0+100+100) &&!empty($_1079396447)){ $_1431248948= Json::decode($_1079396447);}  if($_1431248948 !== null){ $_692340379= Application::getConnection(); $_1983250288= RuleRecordTable::getTableName(); if(!empty($_1431248948)){ foreach($_1431248948 as $_962829069){ if(!static::checkRuleSign($_962829069)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1582084716'][27]($_962829069));}}}  $_692340379->truncateTable($_1983250288);  if(!empty($_1431248948)){ $_563862972=[]; foreach($_1431248948 as $_962829069){ $_563862972[]= ___1116726986(65). $_692340379->getSqlHelper()->forSql($_962829069[___1116726986(66)]). ___1116726986(67). $_692340379->getSqlHelper()->forSql($_962829069[___1116726986(68)]). ___1116726986(69). $_692340379->getSqlHelper()->forSql($_962829069[___1116726986(70)]). ___1116726986(71);} $_1728674555= $GLOBALS['____1582084716'][28](___1116726986(72), $_563862972);  $_692340379->query("INSERT INTO {$_1983250288} (DATA, MODULE, MODULE_VERSION) VALUES {$_1728674555}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_250530012){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1116726986(73), ___1116726986(74), ___1116726986(75), ___1116726986(76). $_250530012->getMessage(). ___1116726986(77). $_250530012->getTraceAsString());}} protected static function checkRuleSign($_1195868848){ $_2084489405= new PublicKeyCipher; $_1746005526= $_2084489405->decrypt($_1195868848[___1116726986(78)], static::__425599039()); return str_starts_with($_1746005526, ___1116726986(79));} private static function __425599039(){ $_1204209496= ''; $_1204209496 .= ___1116726986(80); $_1204209496 .= ___1116726986(81); return $_1204209496;} protected function logEvent($_531803135, $_688673402, $_1744409084){ if($this->_2069864219){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_531803135, 'main', $_688673402, $_1744409084);}}}?>