#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è —à–∞–±–ª–æ–Ω–æ–≤ –∫–∞—Ç–∞–ª–æ–≥–∞
# GIS Mining - Catalog Cleanup Script
# –î–∞—Ç–∞: 2025-12-16

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üßπ =========================================="
echo "   –û–ß–ò–°–¢–ö–ê –î–£–ë–õ–ò–†–£–Æ–©–ò–•–°–Ø –®–ê–ë–õ–û–ù–û–í –ö–ê–¢–ê–õ–û–ì–ê"
echo "==========================================="
echo ""

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
PROJECT_DIR="$(pwd)"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/tmp/bitrix_cleanup_backup_${TIMESTAMP}"

echo "üìÇ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $PROJECT_DIR"
echo "üì¶ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –±—ç–∫–∞–ø–∞: $BACKUP_DIR"
echo ""

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±—ç–∫–∞–ø–∞
echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞..."
mkdir -p "$BACKUP_DIR"

# –ú–∞—Å—Å–∏–≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
declare -a DIRS_TO_REMOVE=(
    "local/templates/main/components/bitrix/catalog.smart.filter"
    "local/templates/main/components/bitrix/catalog.section"
    "local/templates/main/components/bitrix/system.pagenavigation/catalog_pag_OLD_BACKUP"
)

# –ú–∞—Å—Å–∏–≤ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
declare -a FILES_TO_CHECK=(
    "catalog/.section.php"
    "catalog/gpu/.section.php"
    "catalog/conteynery/.section.php"
    "catalog/investicii/.section.php"
    "catalog/gotovyy-biznes/.section.php"
)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
for dir in "${DIRS_TO_REMOVE[@]}"; do
    if [ -d "$dir" ]; then
        echo "   ‚úì –ù–∞–π–¥–µ–Ω–∞: $dir"
        # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –≤ –±—ç–∫–∞–ø–µ
        backup_path="$BACKUP_DIR/$dir"
        mkdir -p "$(dirname "$backup_path")"
        cp -r "$dir" "$backup_path"
        echo "   üì¶ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—ç–∫–∞–ø"
    else
        echo "   ‚óã –ù–µ –Ω–∞–π–¥–µ–Ω–∞: $dir (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º)"
    fi
done

echo ""
echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
for dir in "${DIRS_TO_REMOVE[@]}"; do
    if [ -d "$dir" ]; then
        rm -rf "$dir"
        echo "   ‚úì –£–¥–∞–ª–µ–Ω–∞: $dir"
    fi
done

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö .section.php —Ñ–∞–π–ª–æ–≤..."
for file in "${FILES_TO_CHECK[@]}"; do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file")
        echo "   ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω: $file (—Ä–∞–∑–º–µ—Ä: $size –±–∞–π—Ç)"
        echo "      –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º"
        # –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—ç–∫–∞–ø
        backup_file="$BACKUP_DIR/$file"
        mkdir -p "$(dirname "$backup_file")"
        cp "$file" "$backup_file"
        echo "   üì¶ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—ç–∫–∞–ø"
    else
        echo "   ‚óã –ù–µ –Ω–∞–π–¥–µ–Ω: $file"
    fi
done

echo ""
echo "‚úÖ =========================================="
echo "   –û–ß–ò–°–¢–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!"
echo "==========================================="
echo ""
echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
echo "   ‚Ä¢ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —É–¥–∞–ª–µ–Ω–æ: $(echo "${DIRS_TO_REMOVE[@]}" | wc -w)"
echo "   ‚Ä¢ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω –≤: $BACKUP_DIR"
echo ""
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –∫–∞—Ç–∞–ª–æ–≥–∞"
echo "   2. –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç - —É–¥–∞–ª–∏—Ç–µ –±—ç–∫–∞–ø:"
echo "      rm -rf $BACKUP_DIR"
echo "   3. –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏–∑ –±—ç–∫–∞–ø–∞:"
echo "      cp -r $BACKUP_DIR/* ./"
echo ""
echo "üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
echo "   ‚Ä¢ –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à –ë–∏—Ç—Ä–∏–∫—Å"
echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Ñ–∏–ª—å—Ç—Ä–æ–≤"
echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü —Ç–æ–≤–∞—Ä–æ–≤"
echo ""
